// This is your Prisma schema file for HealBridge
// Docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// ENUMS
// ============================================================

enum UserRole {
  PATIENT
  SURVIVOR
  CAREGIVER
  HEALTHCARE_PROFESSIONAL
  MODERATOR
  ADMIN
}

enum ConditionCategory {
  CANCER
  TOURETTE
  LYME
  OTHER
}

enum ContentType {
  ARTICLE
  VIDEO
  PDF
  WEBINAR
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

// ============================================================
// USER & AUTH
// ============================================================

model User {
  id              String    @id @default(uuid()) @db.Uuid
  email           String    @unique
  passwordHash    String    @map("password_hash")
  role            UserRole  @default(PATIENT)
  isVerified      Boolean   @default(false) @map("is_verified")
  is2FAEnabled    Boolean   @default(false) @map("is_2fa_enabled")
  twoFactorSecret String?   @map("two_factor_secret")
  lastLoginAt     DateTime? @map("last_login_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  profile         UserProfile?
  threads         Thread[]
  posts           Post[]
  aiConversations AIConversation[]
  symptomLogs     SymptomLog[]
  medications     MedicationLog[]
  appointments    Appointment[]
  bookmarks       Bookmark[]
  reports         Report[]         @relation("reporter")
  refreshTokens   RefreshToken[]
  notifications   Notification[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  token     String   @unique
  userId    String   @map("user_id") @db.Uuid
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model UserProfile {
  id                 String             @id @default(uuid()) @db.Uuid
  userId             String             @unique @map("user_id") @db.Uuid
  displayName        String             @map("display_name")
  bio                String?            @db.Text
  avatarUrl          String?            @map("avatar_url")
  primaryConditionId String?            @map("primary_condition_id") @db.Uuid
  conditionStage     String?            @map("condition_stage")
  isSurvivor         Boolean            @default(false) @map("is_survivor")
  isAnonymous        Boolean            @default(false) @map("is_anonymous")
  recoveryStory      String?            @map("recovery_story") @db.Text
  verificationStatus VerificationStatus @default(PENDING) @map("verification_status")
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  condition Condition? @relation(fields: [primaryConditionId], references: [id])

  @@map("user_profiles")
}

// ============================================================
// DISEASE CATEGORIZATION
// ============================================================

model Condition {
  id          String            @id @default(uuid()) @db.Uuid
  name        String
  category    ConditionCategory
  subcategory String?
  description String?           @db.Text
  createdAt   DateTime          @default(now()) @map("created_at")

  profiles  UserProfile[]
  forums    Forum[]
  resources ResourceCondition[]

  @@unique([category, name])
  @@map("conditions")
}

// ============================================================
// COMMUNITY & FORUMS
// ============================================================

model Forum {
  id          String   @id @default(uuid()) @db.Uuid
  conditionId String   @map("condition_id") @db.Uuid
  name        String
  description String?  @db.Text
  slug        String   @unique
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  condition Condition @relation(fields: [conditionId], references: [id])
  threads   Thread[]

  @@map("forums")
}

model Thread {
  id        String   @id @default(uuid()) @db.Uuid
  forumId   String   @map("forum_id") @db.Uuid
  authorId  String   @map("author_id") @db.Uuid
  title     String
  content   String   @db.Text
  tags      String[]
  upvotes   Int      @default(0)
  downvotes Int      @default(0)
  isPinned  Boolean  @default(false) @map("is_pinned")
  isLocked  Boolean  @default(false) @map("is_locked")
  viewCount Int      @default(0) @map("view_count")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  forum  Forum  @relation(fields: [forumId], references: [id], onDelete: Cascade)
  author User   @relation(fields: [authorId], references: [id])
  posts  Post[]

  @@map("threads")
}

model Post {
  id        String   @id @default(uuid()) @db.Uuid
  threadId  String   @map("thread_id") @db.Uuid
  authorId  String   @map("author_id") @db.Uuid
  content   String   @db.Text
  upvotes   Int      @default(0)
  downvotes Int      @default(0)
  isEdited  Boolean  @default(false) @map("is_edited")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  thread Thread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  author User   @relation(fields: [authorId], references: [id])

  @@map("posts")
}

// ============================================================
// AI COPILOT
// ============================================================

model AIConversation {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  title     String?
  messages  Json     @default("[]")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("ai_conversations")
}

// ============================================================
// RESOURCES & EDUCATION
// ============================================================

model Resource {
  id          String      @id @default(uuid()) @db.Uuid
  title       String
  description String?     @db.Text
  contentType ContentType @map("content_type")
  url         String
  tags        String[]
  isVerified  Boolean     @default(false) @map("is_verified")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  conditions ResourceCondition[]
  bookmarks  Bookmark[]

  @@map("resources")
}

model ResourceCondition {
  resourceId  String @map("resource_id") @db.Uuid
  conditionId String @map("condition_id") @db.Uuid

  resource  Resource  @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  condition Condition @relation(fields: [conditionId], references: [id], onDelete: Cascade)

  @@id([resourceId, conditionId])
  @@map("resource_conditions")
}

model Bookmark {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  resourceId String   @map("resource_id") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at")

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([userId, resourceId])
  @@map("bookmarks")
}

// ============================================================
// HEALTH TRACKING
// ============================================================

model SymptomLog {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  symptomType String   @map("symptom_type")
  severity    Int      @db.SmallInt // 1-10
  notes       String?  @db.Text
  loggedAt    DateTime @default(now()) @map("logged_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("symptom_logs")
}

model MedicationLog {
  id             String    @id @default(uuid()) @db.Uuid
  userId         String    @map("user_id") @db.Uuid
  medicationName String    @map("medication_name")
  dosage         String?
  frequency      String?
  startDate      DateTime? @map("start_date")
  endDate        DateTime? @map("end_date")
  notes          String?   @db.Text
  createdAt      DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("medication_logs")
}

model Appointment {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  title       String
  provider    String?
  location    String?
  notes       String?  @db.Text
  scheduledAt DateTime @map("scheduled_at")
  createdAt   DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("appointments")
}

// ============================================================
// MODERATION & REPORTING
// ============================================================

model Report {
  id         String    @id @default(uuid()) @db.Uuid
  reporterId String    @map("reporter_id") @db.Uuid
  targetType String    @map("target_type") // 'thread', 'post', 'user'
  targetId   String    @map("target_id") @db.Uuid
  reason     String    @db.Text
  status     String    @default("pending") // pending, reviewed, resolved, dismissed
  resolvedAt DateTime? @map("resolved_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  reporter User @relation("reporter", fields: [reporterId], references: [id])

  @@map("reports")
}

// ============================================================
// NOTIFICATIONS
// ============================================================

model Notification {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  type      String // 'reply', 'mention', 'match', 'system'
  title     String
  message   String   @db.Text
  isRead    Boolean  @default(false) @map("is_read")
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

// ============================================================
// AUDIT LOG (HIPAA Compliance)
// ============================================================

model AuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String?  @map("user_id") @db.Uuid
  action     String // 'login', 'view_profile', 'export_data', etc.
  entityType String?  @map("entity_type")
  entityId   String?  @map("entity_id") @db.Uuid
  metadata   Json?
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}
